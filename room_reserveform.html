<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Reservation</title>
    <link rel="stylesheet" href="style.css" />
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Koh+Santepheap:wght@100;300;400;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Konkhmer+Sleokchher&display=swap" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <header id="header">
        <img src="pic/img1.png" alt="" id="img1" />
        <div id="main">
            <h5 id="heading1"><a href="room.html">Room</a></h5>
            <h5 id="heading2"><a href="status.html">Status</a></h5>
            <h5 id="heading3"><a href="vehicle.html">Vehicles</a></h5>
            <button id="btn"><a href="logout.html">Logout</a></button>
            <div class="account-wrapper">
                <div id="acc">
                    <img src="pic/image 30.png" alt="" id="accToggle">
                </div>
                <div id="accDropdown" class="dropdown">
                    <a href="settings.html">Settings</a>
                    <a href="logout.html">Logout</a>
                </div>
            </div>
        </div>
    </header>

    <div id="reserve"></div>
    <div id="transparent-room">
        <h2 id="room-text">Reservation</h2>
        <form id="reservation-form">
            <input type="hidden" name="user_id" value="1"> <!-- Replace with actual user_id from session -->
            <input type="hidden" name="room_id" readonly required>
            <input type="text" name="room_name" readonly required>
            <input type="date" name="booking_date" placeholder="Enter your Date" required>
            <input type="time" name="start_time" placeholder="Enter your Time" required>
            <input type="text" name="department_name" placeholder="Enter your Department Name" required>
            <input type="number" name="hours" placeholder="Enter Duration (hours)" min="1" max="8" required>
            <button type="submit" id="room-btn">Submit</button>
        </form>
    </div>

    <footer>
        <div id="main5">
            <div>
                <img src="pic/image.png" alt="" />
            </div>
            <div id="main6">
                <h5>Contact Info</h5>
                <p>Â© 2025 Alkhidmat Foundation</p>
                <p>Vehicle and Board room reservation</p>
            </div>
            <div id="main7">
                <h5>Quick Links</h5>
                <p>Rooms</p>
                <p>Vehicles</p>
                <p>Status</p>
            </div>
        </div>
        <div id="icons">
            <img src="pic/image 11 (2).png" alt="" />
            <img src="pic/image 16 (1).png" alt="" />
            <img src="pic/image 17 (1).png" alt="" />
            <img src="pic/image 18 (1).png" alt="" />
            <img src="pic/image 19 (1).png" alt="" />
        </div>
    </footer>

    <script>
        // Get room_id and room_name from URL
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room_id');
        const roomName = urlParams.get('room_name') || 'Meeting Room A';
        
        // Validate room_id
        if (!roomId) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Room ID is missing. Please select a room first.'
            });
        } else {
            document.querySelector('input[name="room_id"]').value = roomId;
            document.querySelector('input[name="room_name"]').value = roomName;
            document.getElementById('room-text').textContent = `Reservation for ${roomName}`;
        }

        // Format time to AM/PM for display
        function formatTimeToAMPM(timeStr) {
            const [hours, minutes] = timeStr.split(':');
            const hoursNum = parseInt(hours);
            const period = hoursNum >= 12 ? 'PM' : 'AM';
            const formattedHours = hoursNum % 12 || 12;
            return `${formattedHours}:${minutes} ${period}`;
        }

        // Handle form submission
        document.getElementById('reservation-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('Form submitted');

            const formData = new FormData(e.target);
            const data = {
                user_id: parseInt(formData.get('user_id')),
                room_id: parseInt(formData.get('room_id')),
                department_name: formData.get('department_name'),
                booking_date: formData.get('booking_date'),
                start_time: formData.get('start_time'),
                hours: parseInt(formData.get('hours'))
            };

            // Validate booking_date (not in the past)
            const today = new Date();
            const selectedDate = new Date(data.booking_date);
            if (selectedDate < today.setHours(0, 0, 0, 0)) {
                Swal.fire({
                    icon: 'error',
                    title: 'Invalid Date',
                    text: 'Booking date cannot be in the past.'
                });
                return;
            }

            // Validate hours
            if (!data.hours || data.hours > 8 || data.hours < 1) {
                Swal.fire({
                    icon: 'error',
                    title: 'Invalid Duration',
                    text: 'Duration must be between 1 and 8 hours.'
                });
                return;
            }

            console.log('Data sent:', data);

            try {
                const response = await fetch('http://localhost:5000/reserve_room', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                console.log('Response:', result);

                if (response.ok) {
                    const formattedTime = formatTimeToAMPM(result.start_time);
                    Swal.fire({
                        icon: 'success',
                        title: 'Reservation Confirmed!',
                        text: `Room reserved for ${data.booking_date} at ${formattedTime}`,
                        confirmButtonColor: '#3085d6'
                    }).then(() => {
                        window.location.href = 'status.html';
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Submission Failed',
                        text: result.error || 'Something went wrong! Check server logs.'
                    });
                }
            } catch (error) {
                console.error('Submission error:', error.message);
                Swal.fire({
                    icon: 'error',
                    title: 'Network Error',
                    text: `Unable to connect to the server: ${error.message}. Please check if the server is running.`
                });
            }
        });

        // Account dropdown
        const accToggle = document.getElementById("accToggle");
        const accDropdown = document.getElementById("accDropdown");
        accToggle.addEventListener("click", () => {
            accDropdown.style.display = accDropdown.style.display === "block" ? "none" : "block";
        });
        window.addEventListener("click", e => {
            if (!accToggle.contains(e.target) && !accDropdown.contains(e.target)) {
                accDropdown.style.display = "none";
            }
        });
    </script>
</body>
</html>