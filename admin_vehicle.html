<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Vehicle Management</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
    />
    <style>
      body {
        background-color: #f4f7fe;
        font-family: "Segoe UI", sans-serif;
        overflow-x: hidden;
      }
      .sidebar {
        width: 240px;
        position: fixed;
        height: 100vh;
        background: linear-gradient(135deg, #004aad, #023e8a);
        color: white;
        padding: 30px 20px;
      }
      .sidebar h3 {
        font-weight: bold;
        margin-bottom: 30px;
      }
      .sidebar a {
        color: white;
        display: block;
        margin: 15px 0;
        text-decoration: none;
        transition: 0.3s;
      }
      .sidebar a:hover {
        color: #ffd700;
      }
      .topbar {
        height: 70px;
        background-color: white;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        margin-left: 240px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 30px;
      }
      #car-image {
        width: calc(100% - 260px);
        height: 350px;
        margin-left: 260px;
        margin-top: 30px;
        padding-right: 20px;
      }
      #car-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      #new {
        display: flex;
        align-items: center;
        margin-left: 260px;
        margin-top: 20px;
        margin-bottom: 10px;
        gap: 20px;
      }
      #new h2 {
        padding-top: 4px;
        margin-left: 400px;
      }
      #new button {
        width: 110px;
        height: 36px;
        background-color: #004aad;
        color: white;
        border: none;
        margin-left: 440px;
        border-radius: 6px;
      }
      .table-wrapper {
        margin-left: 260px;
        margin-right: 20px;
        margin-bottom: 30px;
        background: white;
        padding: 12px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }
      .table-custom {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 8px;
        overflow: hidden;
      }
      .table-custom thead {
        background-color: #004aad;
        color: white;
      }
      .table-custom th,
      .table-custom td {
        padding: 14px 20px;
        text-align: center;
        font-size: 15px;
        vertical-align: middle;
      }
      .btn-cancel {
        background-color: #dc3545;
        border: none;
        border-radius: 5px;
        padding: 6px 12px;
        color: white;
        font-weight: bold;
      }
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(3px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }
      .modal-content-custom {
        border: 6px solid #004aad;
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        width: 420px;
        max-width: 95%;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        max-height: 90vh;
        overflow-y: auto;
      }
      .modal-content-custom h5 {
        width: 100%;
        text-align: center;
        background-color: #004aad;
        padding: 10px;
        color: white;
        margin: -20px -20px 20px -20px;
        border-radius: 5px 5px 0 0;
      }
      #save {
        width: 100%;
        margin-top: 12px;
        background-color: #004aad;
      }
      #cancelForm {
        width: 100%;
        margin-top: 8px;
      }
      .thumb {
        width: 80px;
        height: 60px;
        object-fit: cover;
        border-radius: 8px;
      }
      .form-text-muted {
        font-size: 12px;
        color: #6c757d;
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <h3>Admin Panel</h3>
      <a href="admin.html"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a>
      <a href="bookings.html"
        ><i class="bi bi-calendar-check me-2"></i>Bookings</a
      >
      <a href="admin_room.html"><i class="bi bi-door-open me-2"></i>Rooms</a>
      <a href="admin_vehicle.html"
        ><i class="bi bi-truck-front me-2"></i>Vehicles</a
      >
      <a href="admin_setting.html"><i class="bi bi-gear me-2"></i>Settings</a>
      <a href="admin_logout.html"
        ><i class="bi bi-box-arrow-right me-2"></i>Logout</a
      >
    </div>

    <div class="topbar">
      <h5>Welcome, Admin</h5>
      <div class="dropdown">
        <img
          src="pic/admin.png"
          class="rounded-circle dropdown-toggle"
          width="40"
          height="40"
          role="button"
          data-bs-toggle="dropdown"
          aria-expanded="false"
          style="cursor: pointer; object-fit: cover"
        />
        <ul class="dropdown-menu dropdown-menu-end shadow animated-dropdown">
          <li>
            <a class="dropdown-item" href="admin_setting.html"
              >Account Settings</a
            >
          </li>
          <li>
            <a class="dropdown-item text-danger" href="admin_logout.html"
              >Logout</a
            >
          </li>
        </ul>
      </div>
    </div>

    <div id="car-image">
      <img src="pic/fix image.png" alt="" />
    </div>

    <div id="new">
      <h2>Vehicles</h2>
      <button id="addVehicleBtn" type="button">Add New</button>
    </div>

    <!-- Modal -->
    <div id="modalOverlay" class="modal-overlay">
      <div class="modal-content-custom">
        <h5>Add New Vehicle</h5>
        <form id="vehicleForm">
          <div class="mb-3">
            <label for="vehicleType" class="form-label">Vehicle Type</label>
            <input
              type="text"
              id="vehicleType"
              class="form-control"
              placeholder="Enter vehicle type"
              required
            />
          </div>
          <div class="mb-3">
            <label for="carName" class="form-label">Vehicle Name</label>
            <input
              type="text"
              id="carName"
              class="form-control"
              placeholder="Enter vehicle name"
              required
            />
          </div>
          <div class="mb-3">
            <label for="driverName" class="form-label">Driver Name</label>
            <input
              type="text"
              id="driverName"
              class="form-control"
              placeholder="Enter driver name"
              required
            />
          </div>
          <div class="mb-3">
            <label for="driverPhone" class="form-label">Driver Phone</label>
            <input
              type="text"
              id="driverPhone"
              class="form-control"
              placeholder="Enter driver phone"
              required
            />
          </div>
          <div class="mb-1">
            <label class="form-label">Photo</label>
            <input
              type="file"
              id="photoFile"
              class="form-control"
              accept="image/*"
            />
            <div class="form-text-muted">
              You can upload a file <b>or</b> paste a photo URL below.
            </div>
          </div>
          <div class="mb-3">
            <input
              type="text"
              id="photoUrl"
              class="form-control"
              placeholder="https://example.com/vehicle.jpg (optional)"
            />
          </div>
          <div class="mb-3 d-flex justify-content-center">
            <img id="preview" class="thumb d-none" alt="preview" />
          </div>
          <button type="submit" class="btn btn-primary" id="save">Save</button>
          <button type="button" class="btn btn-secondary" id="cancelForm">
            Cancel
          </button>
        </form>
      </div>
    </div>

    <div class="table-wrapper">
      <table class="table-custom">
        <thead>
          <tr>
            <th>Photo</th>
            <th>Vehicle Type</th>
            <th>Vehicle Name</th>
            <th>Driver Name</th>
            <th>Driver Phone</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      const addBtn = document.getElementById("addVehicleBtn");
      const modalOverlay = document.getElementById("modalOverlay");
      const cancelBtn = document.getElementById("cancelForm");
      const vehicleForm = document.getElementById("vehicleForm");
      const tbody = document.querySelector(".table-custom tbody");
      const photoFile = document.getElementById("photoFile");
      const photoUrl = document.getElementById("photoUrl");
      const preview = document.getElementById("preview");

      const API_URL = "http://localhost:5000/vehicles";

      // Load vehicles on page load
      window.addEventListener("DOMContentLoaded", loadVehicles);

      addBtn.addEventListener("click", () => {
        modalOverlay.style.display = "flex";
      });

      cancelBtn.addEventListener("click", closeModal);

      function closeModal() {
        modalOverlay.style.display = "none";
        vehicleForm.reset();
        preview.src = "";
        preview.classList.add("d-none");
      }

      modalOverlay.addEventListener("click", (e) => {
        if (e.target === modalOverlay) closeModal();
      });

      // Preview logic
      photoFile.addEventListener("change", () => {
        const file = photoFile.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (ev) => {
            preview.src = ev.target.result;
            preview.classList.remove("d-none");
          };
          reader.readAsDataURL(file);
        } else {
          preview.src = "";
          preview.classList.add("d-none");
        }
      });

      photoUrl.addEventListener("input", () => {
        const url = photoUrl.value.trim();
        if (url) {
          preview.src = url;
          preview.classList.remove("d-none");
        } else if (!photoFile.files.length) {
          preview.src = "";
          preview.classList.add("d-none");
        }
      });

      // Add vehicle
      vehicleForm.addEventListener("submit", async function (e) {
        e.preventDefault();
        const vehicleType = document.getElementById("vehicleType").value.trim();
        const carName = document.getElementById("carName").value.trim();
        const driverName = document.getElementById("driverName").value.trim();
        const driverPhone = document.getElementById("driverPhone").value.trim();

        if (!vehicleType || !carName || !driverName || !driverPhone) {
          Swal.fire({
            icon: "error",
            title: "Validation Error",
            text: "Please fill all required fields.",
            confirmButtonColor: "#004aad",
          });
          return;
        }

        const fd = new FormData();
        fd.append("vehicle_type", vehicleType);
        fd.append("car_name", carName);
        fd.append("driver_name", driverName);
        fd.append("driver_phone", driverPhone);

        // Prefer file if chosen; else send URL if provided
        if (photoFile.files[0]) {
          fd.append("photo", photoFile.files[0]);
        } else if (photoUrl.value.trim()) {
          fd.append("photo_url", photoUrl.value.trim());
        }

        try {
          const res = await fetch(API_URL, { method: "POST", body: fd });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            Swal.fire({
              icon: "error",
              title: "Error",
              text: "Failed to save vehicle" + (err.error ? ": " + err.error : ""),
              confirmButtonColor: "#004aad",
            });
            return;
          }

          const savedVehicle = await res.json();
          addVehicleToTable(savedVehicle);
          closeModal();
          Swal.fire({
            icon: "success",
            title: "Success",
            text: "Vehicle added successfully!",
            confirmButtonColor: "#004aad",
          });
        } catch (err) {
          console.error("Error saving vehicle:", err);
          Swal.fire({
            icon: "error",
            title: "Error",
            text: "Failed to save vehicle: Network error",
            confirmButtonColor: "#004aad",
          });
        }
      });

      // Delete vehicle
      tbody.addEventListener("click", async function (e) {
        if (e.target && e.target.matches(".btn-cancel")) {
          const row = e.target.closest("tr");
          const vehicleId = row.dataset.id;
          const result = await Swal.fire({
            icon: "warning",
            title: "Are you sure?",
            text: "Do you want to delete this vehicle?",
            showCancelButton: true,
            confirmButtonColor: "#004aad",
            cancelButtonColor: "#dc3545",
            confirmButtonText: "Yes, delete it!",
          });

          if (!result.isConfirmed) return;

          try {
            const res = await fetch(`${API_URL}/${vehicleId}`, {
              method: "DELETE",
            });
            if (!res.ok) {
              const err = await res.json().catch(() => ({}));
              Swal.fire({
                icon: "error",
                title: "Error",
                text: "Failed to delete" + (err.error ? ": " + err.error : ""),
                confirmButtonColor: "#004aad",
              });
              return;
            }
            row.remove();
            Swal.fire({
              icon: "success",
              title: "Deleted",
              text: "Vehicle deleted successfully!",
              confirmButtonColor: "#004aad",
            });
          } catch (err) {
            console.error("Error deleting vehicle:", err);
            Swal.fire({
              icon: "error",
              title: "Error",
              text: "Failed to delete vehicle: Network error",
              confirmButtonColor: "#004aad",
            });
          }
        }
      });

      function addVehicleToTable(vehicle) {
        const tr = document.createElement("tr");
        tr.dataset.id = vehicle.vehicle_id;
        tr.innerHTML = `
        <td>${
          vehicle.photo_url
            ? `<img src="${escapeHtml(
                vehicle.photo_url
              )}" alt="Vehicle" class="thumb">`
            : "-"
        }</td>
        <td>${escapeHtml(vehicle.vehicle_type)}</td>
        <td>${escapeHtml(vehicle.car_name)}</td>
        <td>${escapeHtml(vehicle.driver_name)}</td>
        <td>${escapeHtml(vehicle.driver_phone)}</td>
        <td><button class="btn-cancel">Delete</button></td>
      `;
        tbody.prepend(tr);
      }

      async function loadVehicles() {
        try {
          const res = await fetch(API_URL);
          if (!res.ok) {
            console.error("Failed to fetch vehicles:", res.status);
            Swal.fire({
              icon: "error",
              title: "Error",
              text: "Failed to load vehicles",
              confirmButtonColor: "#004aad",
            });
            return;
          }
          const vehicles = await res.json();
          tbody.innerHTML = "";
          vehicles.forEach(addVehicleToTable);
        } catch (err) {
          console.error("Error loading vehicles:", err);
          Swal.fire({
            icon: "error",
            title: "Error",
            text: "Failed to load vehicles: Network error",
            confirmButtonColor: "#004aad",
          });
        }
      }

      function escapeHtml(str) {
        return str.replace(
          /[&<>"']/g,
          (m) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[m])
        );
      }
    </script>
  </body>
</html>