<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admin Bookings</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
body { background-color: #f4f7fe; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }

/* Sidebar */
.sidebar { width: 240px; position: fixed; height: 100vh; background: linear-gradient(135deg, #004aad, #023e8a); color: white; padding: 30px 20px; transition: all 0.3s; }
.sidebar h3 { font-weight: bold; margin-bottom: 30px; }
.sidebar a { color: white; display: block; margin: 15px 0; text-decoration: none; transition: 0.3s; }
.sidebar a:hover { color: #ffd700; }
.sidebar.active { left: 0; }

/* Topbar */
.topbar { height: 70px; background-color: white; box-shadow: 0 1px 4px rgba(0,0,0,0.1); margin-left: 240px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; transition: all 0.3s; }

/* Main content */
.main { margin-left: 240px; padding: 20px; transition: all 0.3s; }

/* Dashboard Cards */
#display { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; margin: 30px 0; }
.card-container { flex: 1 1 300px; min-width: 280px; display: flex; justify-content: center; align-items: center; border-radius: 8px; padding: 15px; height: 170px; box-sizing: border-box; }
.card-container img { max-width: 100%; max-height: 100%; object-fit: contain; }

/* Search */
#search-flex { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-top: 20px; }
#search { position: relative; flex: 1; min-width: 250px; }
#search i { position: absolute; left: 15px; top: 12px; color: #FFC107; font-size: 18px; }
#search-btn { width: 100%; height: 44px; border: none; background-color: #d9d9d994; padding-left: 45px; border-radius: 5px; }
#searching { height: 44px; padding: 0 20px; background-color: #FFC107; border: none; color: white; font-weight: bold; border-radius: 5px; white-space: nowrap; }

/* Tables */
.table-custom { width: 100%; margin-top: 20px; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); min-width: 800px; }
.table-custom th, .table-custom td { padding: 12px 15px; text-align: center; font-size: 14px; word-break: break-word; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
.table-custom thead { background-color: #004aad; color: white; }
.table-custom tbody tr:nth-child(even) { background-color: #f8f9fa; }

/* Badges and buttons */
.badge-status { padding: 5px 10px; border-radius: 5px; color: white; font-weight: bold; }
.badge-approved { background-color: #28A745; }
.badge-cancelled { background-color: #DC3545; }
.badge-pending { background-color: #FFC107; color: black; }
.btn-approve { background-color: #28A745; border: none; border-radius: 5px; padding: 5px 10px; color: white; margin-top: 5px; }
.btn-cancel { background-color: #DC3545; border: none; border-radius: 5px; padding: 5px 10px; color: white; margin-top: 5px; }

/* Download buttons */
.download-buttons { text-align: center; margin: 10px 0; flex-wrap: wrap; }
.download-buttons button { margin: 5px; }

/* Responsive tables */
.table-responsive { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }

/* Responsive adjustments */
@media (max-width: 991px) {
  .sidebar { position: absolute; left: -240px; top: 0; z-index: 1000; }
  .topbar { margin-left: 0; }
  .main { margin-left: 0; }
}

@media (max-width: 576px) {
  /* Dashboard Cards */
  #display {
    display: flex;
    flex-wrap: nowrap; /* horizontal scroll for mobile */
    justify-content: flex-start;
    gap: 10px;
    padding: 10px 5px;
    overflow-x: auto;
  }
  .card-container {
    flex: 0 0 70%; /* card width 70% of mobile screen */
    max-width: 70%;
    height: 120px;
    padding: 5px;
    border-radius: 8px;
    box-sizing: border-box;
  }
  .card-container img { width: 100%; height: 100%; object-fit: contain; }

  /* Topbar adjustments */
  .topbar {
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    padding: 0 10px;
  }
  .topbar h6 {
    font-size: 0.95rem;
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 60%;
  }
  .topbar .dropdown img {
    width: 35px;
    height: 35px;
  }

  /* Search Input + Button side by side */
  #search-flex {
    flex-direction: row;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 10px;
  }
  #search { flex: 1 1 auto; min-width: 60%; position: relative; }
  #search i { left: 10px; top: 10px; }
  #search-btn { width: 100%; height: 40px; padding-left: 35px; font-size: 0.9rem; }
  #searching { flex: 0 0 auto; height: 40px; padding: 0 10px; font-size: 0.9rem; }

  /* Headings */
  h2.section-title { font-size: 1rem; margin-top: 15px; }

  /* Tables adjustments */
  .table-responsive { overflow-x: auto; }
  .table-custom { min-width: 100%; font-size: 11px; }
  .table-custom th, .table-custom td { padding: 6px 8px; white-space: nowrap; }

  /* Badges and buttons smaller */
  .badge-status { font-size: 10px; padding: 3px 5px; }
  .btn-approve, .btn-cancel { font-size: 10px; padding: 3px 5px; margin-top: 3px; }

  /* Download buttons smaller */
  .download-buttons button { font-size: 0.8rem; padding: 5px 8px; margin: 3px; }
}
</style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
  <h3>Admin Panel</h3>
  <a href="admin.html"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a>
  <a href="bookings.html"><i class="bi bi-calendar-check me-2"></i>Bookings</a>
  <a href="admin_room.html"><i class="bi bi-door-open me-2"></i>Rooms</a>
  <a href="admin_vehicle.html"><i class="bi bi-truck-front me-2"></i>Vehicles</a>
  <a href="admin_setting.html"><i class="bi bi-gear me-2"></i>Settings</a>
  <a href="admin_logout.html"><i class="bi bi-box-arrow-right me-2"></i>Logout</a>
</div>

<!-- Topbar -->
<div class="topbar">
  <button class="btn btn-outline-primary d-lg-none" id="menu-toggle"><i class="bi bi-list"></i></button>
  <h6 class="mb-0">Welcome, Admin</h6>
  <div class="dropdown">
    <img src="./images/admin.png" class="rounded-circle dropdown-toggle" width="40" height="40" role="button" data-bs-toggle="dropdown" aria-expanded="false" style="cursor:pointer; object-fit:cover;" />
    <ul class="dropdown-menu dropdown-menu-end shadow">
      <li><a class="dropdown-item" href="admin_setting.html">Account Settings</a></li>
      <li><a class="dropdown-item text-danger" href="admin_logout.html">Logout</a></li>
    </ul>
  </div>
</div>

<!-- Dashboard Cards -->
<div id="display" class="main">
  <div class="card-container" style="background-color:#E79C23;">
    <img src="./images/display1.png" alt="Display 1">
  </div>
  <div class="card-container" style="background-color:#78B029;">
    <img src="./images/display2.png" alt="Display 2">
  </div>
</div>

<div class="main">
  <!-- Search -->
  <div id="search-flex">
    <div id="search">
      <i class="bi bi-search"></i>
      <input type="text" placeholder="Search by Department" id="search-btn">
    </div>
    <button id="searching">Search</button>
  </div>

  <!-- Boardroom Reservations -->
  <h2 class="section-title text-center mt-4">Boardroom Reservations</h2>
  <div class="download-buttons">
    <button class="btn btn-primary" onclick="downloadCSV('#room-table', 'boardroom_reservations.csv')"><i class="bi bi-file-earmark-excel"></i> CSV</button>
    <button class="btn btn-danger" onclick="downloadPDF('#room-table', 'Boardroom Reservations')"><i class="bi bi-file-earmark-pdf"></i> PDF</button>
  </div>
  <div class="table-responsive">
    <table class="table table-bordered table-striped table-custom" id="room-table">
      <thead>
        <tr>
          <th>User</th>
          <th>Date</th>
          <th>Time</th>
          <th>Department</th>
          <th>Room</th>
          <th>Emergency</th>
          <th>Hours</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="room-tbody"></tbody>
    </table>
  </div>

  <!-- Vehicle Reservations -->
  <h2 class="section-title text-center mt-4">Vehicle Reservations</h2>
  <div class="download-buttons">
    <button class="btn btn-primary" onclick="downloadCSV('#vehicle-table', 'vehicle_reservations.csv')"><i class="bi bi-file-earmark-excel"></i> CSV</button>
    <button class="btn btn-danger" onclick="downloadPDF('#vehicle-table', 'Vehicle Reservations')"><i class="bi bi-file-earmark-pdf"></i> PDF</button>
  </div>
  <div class="table-responsive">
    <table class="table table-bordered table-striped table-custom" id="vehicle-table">
      <thead>
        <tr>
          <th>User</th>
          <th>Date</th>
          <th>Time</th>
          <th>Department</th>
          <th>Vehicle</th>
          <th>From</th>
          <th>To</th>
          <th>Emergency</th>
          <th>Hours</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="vehicle-tbody"></tbody>
    </table>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const apiBase = "http://localhost:5000";

  async function fetchReservations() {
    try {
      // Rooms
      const roomRes = await fetch(`${apiBase}/reservations_room`);
      const rooms = await roomRes.json();
      const roomTbody = document.getElementById("room-tbody");
      roomTbody.innerHTML = "";
      rooms.forEach(r => {
        const status = r.status || 'Pending';
        const badge = `<span class="badge-status ${status==='Approved'?'badge-approved':status==='Cancelled'?'badge-cancelled':'badge-pending'}">${status}</span>`;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.user_id}</td>
          <td>${r.booking_date}</td>
          <td>${r.start_time}</td>
          <td>${r.department_name}</td>
          <td>${r.room_id}</td>
          <td>${r.emergency || 'No'}</td>
          <td>${r.hours}</td>
          <td>${badge} <br/>
            <button class="btn-approve" onclick="updateRoomStatus(${r.booking_id}, 'Approved')">Approve</button>
            <button class="btn-cancel" onclick="updateRoomStatus(${r.booking_id}, 'Cancelled')">Cancel</button>
          </td>
        `;
        roomTbody.appendChild(tr);
      });

      // Vehicles
      const vehicleRes = await fetch(`${apiBase}/reservations_vehicle`);
      const vehicles = await vehicleRes.json();
      const vehicleTbody = document.getElementById("vehicle-tbody");
      vehicleTbody.innerHTML = "";
      vehicles.forEach(v => {
        const status = v.status || 'Pending';
        const badge = `<span class="badge-status ${status==='Approved'?'badge-approved':status==='Cancelled'?'badge-cancelled':'badge-pending'}">${status}</span>`;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${v.user_id}</td>
          <td>${v.booking_date}</td>
          <td>${v.start_time}</td>
          <td>${v.department_name}</td>
          <td>${v.vehicle_id}</td>
          <td>${v.from || ''}</td>
          <td>${v.to || ''}</td>
          <td>${v.emergency || 'No'}</td>
          <td>${v.hours}</td>
          <td>${badge} <br/>
            <button class="btn-approve" onclick="updateVehicleStatus(${v.booking_id}, 'Approved')">Approve</button>
            <button class="btn-cancel" onclick="updateVehicleStatus(${v.booking_id}, 'Cancelled')">Cancel</button>
          </td>
        `;
        vehicleTbody.appendChild(tr);
      });

    } catch(err) { console.error(err); }
  }

  async function updateRoomStatus(id, status) {
    await fetch(`${apiBase}/update_room_status`, { method:"PATCH", headers:{"Content-Type":"application/json"}, body:JSON.stringify({booking_id:id,status}) });
    fetchReservations();
  }

  async function updateVehicleStatus(id, status) {
    await fetch(`${apiBase}/update_vehicle_status`, { method:"PATCH", headers:{"Content-Type":"application/json"}, body:JSON.stringify({booking_id:id,status}) });
    fetchReservations();
  }

  document.getElementById("searching").addEventListener("click", function() {
    const searchValue = document.getElementById("search-btn").value.toLowerCase();
    document.querySelectorAll("#room-tbody tr, #vehicle-tbody tr").forEach(row => {
      const deptCell = row.cells[3]?.innerText.toLowerCase();
      row.style.display = deptCell?.includes(searchValue) ? "" : "none";
    });
  });

  function downloadCSV(tableSelector, filename) {
    const rows = document.querySelectorAll(`${tableSelector} tr`);
    let csv = "";
    rows.forEach(r => {
      const cols = r.querySelectorAll("td, th");
      csv += Array.from(cols).map(c=>`"${c.innerText.replace(/\n/g,' ').trim()}"`).join(",") + "\n";
    });
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
  }

  function downloadPDF(tableSelector, title) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text(title, 14, 20);
    doc.autoTable({ html: tableSelector, startY: 30 });
    doc.save(title+".pdf");
  }

  document.getElementById("menu-toggle").addEventListener("click", function () {
    document.getElementById("sidebar").classList.toggle("active");
  });

  fetchReservations();
</script>
</body>
</html>

