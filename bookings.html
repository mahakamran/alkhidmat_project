<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Bookings</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { background-color: #f4f7fe; font-family: 'Segoe UI', sans-serif; }
    .sidebar { width: 240px; position: fixed; height: 100vh; background: linear-gradient(135deg, #004aad, #023e8a); color: white; padding: 30px 20px; }
    .sidebar h3 { font-weight: bold; margin-bottom: 30px; }
    .sidebar a { color: white; display: block; margin: 15px 0; text-decoration: none; transition: 0.3s; }
    .sidebar a:hover { color: #ffd700; }
    .topbar { height: 70px; background-color: white; box-shadow: 0 1px 4px rgba(0,0,0,0.1); margin-left: 240px; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; }
    .main { margin-left: 240px; padding: 40px; }
    .table-custom { width: 100%; margin-top: 20px; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .table-custom th { background-color: #004aad; color: white; padding: 14px 20px; text-align: center; }
    .table-custom td { padding: 14px 20px; text-align: center; }
    .badge-status { padding: 5px 10px; border-radius: 5px; color: white; font-weight: bold; }
    .badge-approved { background-color: #28A745; }
    .badge-cancelled { background-color: #DC3545; }
    .badge-pending { background-color: #FFC107; color: black; }
    #search-flex { display: flex; align-items: center; margin-top: 30px; }
    #search { position: relative; }
    #search i { position: absolute; left: 15px; top: 12px; color: #FFC107; font-size: 18px; }
    #search-btn { width: 500px; height: 44px; border: none; background-color: #d9d9d994; padding-left: 45px; border-radius: 5px; }
    #searching { margin-left: 20px; height: 44px; width: 100px; background-color: #FFC107; border: none; color: white; font-weight: bold; border-radius: 5px; }
    .download-buttons { margin-top: 10px; margin-bottom: 20px; text-align: right; }
    .download-buttons button { margin-left: 10px; }
  </style>
</head>
<body>

<div class="sidebar">
  <h3>Admin Panel</h3>
  <a href="admin.html"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a>
  <a href="bookings.html"><i class="bi bi-calendar-check me-2"></i>Bookings</a>
  <a href="admin_room.html"><i class="bi bi-door-open me-2"></i>Rooms</a>
  <a href="admin_vehicle.html"><i class="bi bi-truck-front me-2"></i>Vehicles</a>
  <a href="admin_setting.html"><i class="bi bi-gear me-2"></i>Settings</a>
  <a href="admin_logout.html"><i class="bi bi-box-arrow-right me-2"></i>Logout</a>
</div>

<div class="topbar">
  <h5>Welcome, Admin</h5>
</div>

<div class="main">
  <div id="search-flex">
    <div id="search">
      <i class="bi bi-search"></i>
      <input type="text" placeholder="Search by Department" id="search-btn">
    </div>
    <button id="searching">Search</button>
  </div>

  <!-- Room Reservations -->
  <h2 class="section-title mt-4">Boardroom Reservations</h2>
  <div class="download-buttons">
    <button class="btn btn-primary" onclick="downloadCSV('#room-table', 'boardroom_reservations.csv')">
      <i class="bi bi-file-earmark-excel"></i> CSV
    </button>
    <button class="btn btn-danger" onclick="downloadPDF('#room-table', 'Boardroom Reservations')">
      <i class="bi bi-file-earmark-pdf"></i> PDF
    </button>
  </div>
  <table class="table-custom" id="room-table">
    <thead>
      <tr>
        <th>User</th>
        <th>Date</th>
        <th>Time</th>
        <th>Department</th>
        <th>Room</th>
        <th>Hours</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="room-tbody"></tbody>
  </table>

  <!-- Vehicle Reservations -->
  <h2 class="section-title mt-4">Vehicle Reservations</h2>
  <div class="download-buttons">
    <button class="btn btn-primary" onclick="downloadCSV('#vehicle-table', 'vehicle_reservations.csv')">
      <i class="bi bi-file-earmark-excel"></i> CSV
    </button>
    <button class="btn btn-danger" onclick="downloadPDF('#vehicle-table', 'Vehicle Reservations')">
      <i class="bi bi-file-earmark-pdf"></i> PDF
    </button>
  </div>
  <table class="table-custom" id="vehicle-table">
    <thead>
      <tr>
        <th>User</th>
        <th>Date</th>
        <th>Time</th>
        <th>Department</th>
        <th>Vehicle</th>
        <th>Destination</th>
        <th>Hours</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="vehicle-tbody"></tbody>
  </table>
</div>

<script>
  const apiBase = "http://localhost:5000";

  async function fetchReservations() {
    try {
      // Rooms
      const roomRes = await fetch(`${apiBase}/reservations_room`);
      const rooms = await roomRes.json();
      const roomTbody = document.getElementById("room-tbody");
      roomTbody.innerHTML = "";
      rooms.forEach(r => {
        const tr = document.createElement("tr");
        const status = r.status || 'Pending';
        const badge = `<span class="badge-status ${status==='Approved'?'badge-approved':status==='Cancelled'?'badge-cancelled':'badge-pending'}">${status}</span>`;
        tr.innerHTML = `
          <td>${r.user_id}</td>
          <td>${r.booking_date}</td>
          <td>${r.start_time}</td>
          <td>${r.department_name}</td>
          <td>${r.room_id}</td>
          <td>${r.hours}</td>
          <td>${badge} <br/>
              <button class="btn btn-success btn-sm mt-1" onclick="updateRoomStatus(${r.booking_id}, 'Approved')">Approve</button>
              <button class="btn btn-danger btn-sm mt-1" onclick="updateRoomStatus(${r.booking_id}, 'Cancelled')">Cancel</button>
          </td>
        `;
        roomTbody.appendChild(tr);
      });

      // Vehicles
      const vehicleRes = await fetch(`${apiBase}/reservations_vehicle`);
      const vehicles = await vehicleRes.json();
      const vehicleTbody = document.getElementById("vehicle-tbody");
      vehicleTbody.innerHTML = "";
      vehicles.forEach(v => {
        const status = v.status || 'Pending';
        const badge = `<span class="badge-status ${status==='Approved'?'badge-approved':status==='Cancelled'?'badge-cancelled':'badge-pending'}">${status}</span>`;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${v.user_id}</td>
          <td>${v.booking_date}</td>
          <td>${v.start_time}</td>
          <td>${v.department_name}</td>
          <td>${v.vehicle_id}</td>
          <td>${v.destination}</td>
          <td>${v.hours}</td>
          <td>${badge} <br/>
              <button class="btn btn-success btn-sm mt-1" onclick="updateVehicleStatus(${v.booking_id}, 'Approved')">Approve</button>
              <button class="btn btn-danger btn-sm mt-1" onclick="updateVehicleStatus(${v.booking_id}, 'Cancelled')">Cancel</button>
          </td>
        `;
        vehicleTbody.appendChild(tr);
      });

    } catch (err) {
      console.error(err);
    }
  }

  async function updateRoomStatus(id, status) {
    await fetch(`${apiBase}/update_room_status`, {
      method: "PATCH",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({booking_id:id,status})
    });
    fetchReservations();
  }

  async function updateVehicleStatus(id, status) {
    await fetch(`${apiBase}/update_vehicle_status`, {
      method: "PATCH",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({booking_id:id,status})
    });
    fetchReservations();
  }

  // Search by department
  document.getElementById("searching").addEventListener("click", function() {
    const searchValue = document.getElementById("search-btn").value.toLowerCase();
    document.querySelectorAll("#room-tbody tr, #vehicle-tbody tr").forEach(row => {
      const deptCell = row.cells[3].innerText.toLowerCase();
      row.style.display = deptCell.includes(searchValue) ? "" : "none";
    });
  });

  // CSV download
  function downloadCSV(tableSelector, filename) {
    const rows = document.querySelectorAll(`${tableSelector} tr`);
    let csv = "";
    rows.forEach(r => {
      const cols = r.querySelectorAll("td, th");
      const row = Array.from(cols).map(c=>c.innerText.replace(/\n/g,' ').trim()).join(",");
      csv += row + "\n";
    });
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
  }

  // PDF download
  function downloadPDF(tableSelector, title) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text(title, 20, 10);
    doc.autoTable({ html: tableSelector, startY: 20 });
    doc.save(title+".pdf");
  }

  fetchReservations();
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
</body>
</html>
